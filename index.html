<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI 制图工坊</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎨</text></svg>">
  <link rel="stylesheet" href="./styles.css">
</head>

<body>

  <nav class="navbar">
    <div class="brand">
      <div class="brand-icon">🎨</div>
      AI 制图工坊
      <span id="versionDisplay" style="font-size: 0.75rem; color: var(--text-secondary); margin-left: 12px;">v...</span>
    </div>

    <!-- 主导航 Tab -->
    <div class="main-nav">
      <button class="nav-tab active" data-page="single">🖼️ 单图生成</button>
      <button class="nav-tab" data-page="matrix">🔲 风格矩阵</button>
      <button class="nav-tab" data-page="explorations">📁 探索方案</button>
    </div>

    <div style="display: flex; gap: 12px;">
      <button id="btnCheckUpdate" class="btn btn-secondary" style="width: auto; padding: 8px 16px; font-size: 0.9rem;">
        🔄 检查更新
      </button>
      <button id="btnSettings" class="btn btn-secondary" style="width: auto; padding: 8px 16px; font-size: 0.9rem;">
        API Key 设置
      </button>
    </div>
  </nav>

  <!-- 页面视图容器 -->

  <!-- 单图生成页面 -->
  <div id="pageSingle" class="page-view active">
    <div class="main-container">

      <!-- 左侧控制区 -->
      <aside class="control-panel">

        <!-- 生成配置 -->
        <div class="card">
          <div class="tabs">
            <div class="tab active" data-mode="text">文字生成</div>
            <div class="tab" data-mode="style">风格迁移</div>
          </div>

          <!-- 风格选择 (通用) -->
          <!-- 生成主体选择 -->
          <div class="form-group">
            <label class="form-label">生成主体</label>
            <select id="subjectSelect" class="input-field">
              <option value="icon">图标 (Icon)</option>
              <option value="character">角色 (Character)</option>
              <option value="equipment">装备 (Equipment)</option>
              <option value="scene">场景 (Scene)</option>
              <option value="custom">自定义 (Custom)</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">视觉风格 (预设)</label>
            <select id="styleSelect" class="input-field">
              <option value="game asset style, high quality, detailed">通用游戏资产 (Universal)</option>
              <option value="Chinese wuxia/xianxia style, ink painting, ethereal">中国武侠/仙侠 (Wuxia)</option>
              <option value="cyberpunk style, neon lights, high tech, futuristic">赛博朋克 (Cyberpunk)</option>
              <option value="pixel art style, 8-bit, retro game">像素风 (Pixel Art)</option>
              <option value="cartoon style, casual game, bright colors, cute">卡通/休闲 (Casual)</option>
              <option value="dark fantasy style, grim, gothic, detailed">暗黑奇幻 (Dark Fantasy)</option>
              <option value="realistic 3D render, unreal engine 5, 4k">写实 3D (Realistic)</option>
              <option value="">自定义...</option>
            </select>

            <label class="form-label" style="margin-top: 12px;">风格提示词 (可编辑)</label>
            <input type="text" id="customStyleInput" class="input-field" placeholder="输入或选择风格...">
          </div>

          <!-- 生成分辨率选择 -->
          <div class="form-group">
            <label class="form-label">生成分辨率</label>
            <select id="generateResolutionSelect" class="input-field">
              <option value="1024">1K (1024 × 1024)</option>
              <option value="2048">2K (2048 × 2048)</option>
              <option value="4096">4K (4096 × 4096)</option>
            </select>
            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px;">
              更高分辨率生成时间更长，但图标更清晰
            </p>
          </div>

          <!-- 网格大小选择 -->
          <div class="form-group">
            <label class="form-label">网格大小</label>
            <select id="gridSizeSelect" class="input-field">
              <option value="1">1 × 1 (单图)</option>
              <option value="3">3 × 3 (9 个图)</option>
              <option value="5">5 × 5 (25 个图)</option>
            </select>
            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px;">
              选择生成图标的网格布局
            </p>
          </div>

          <!-- 参考图上传 (仅风格迁移模式) -->
          <div id="referenceSection" class="form-group" style="display: none;">
            <label class="form-label">参考图片</label>
            <div class="upload-area" id="uploadZone">
              <input type="file" id="fileInput" accept="image/*" style="display: none;">
              <div class="upload-placeholder" id="uploadPlaceholder">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <span>点击或拖拽上传参考图</span>
              </div>
              <img id="uploadPreview" class="upload-preview-img">
            </div>
          </div>

          <!-- 提示词输入 -->
          <div class="form-group">
            <label class="form-label">图标描述</label>
            <textarea id="promptInput" class="input-field" placeholder="描述这组图标的主题。例如：
- 一套中世纪 RPG 的药水瓶，包含红蓝绿三种颜色
- 科幻风格的能量护盾和电池
- 各种元素的魔法宝石"></textarea>
          </div>

          <button id="btnGenerate" class="btn btn-primary">
            <span>✨ 开始生成</span>
          </button>
        </div>

        <!-- 下载尺寸设置 -->
        <div class="card">
          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">下载尺寸设置</label>
            <select id="downloadSizeSelect" class="input-field">
              <option value="original">原始尺寸</option>
              <option value="256">256 × 256</option>
              <option value="128">128 × 128</option>
              <option value="512">512 × 512</option>
            </select>
            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px;">
              此设置影响单张图标下载和批量下载的尺寸
            </p>
          </div>
        </div>

        <!-- 历史记录 -->
        <div class="history-bar">
          <div class="section-header" style="margin-bottom: 12px;">
            <label class="form-label" style="margin-bottom: 0;">最近生成</label>
            <button id="btnClearHistory" class="btn btn-secondary"
              style="width: auto; padding: 6px 12px; font-size: 0.8rem;">
              🗑️ 清理历史
            </button>
          </div>
          <div class="history-list" id="historyList">
            <!-- 历史项将通过 JS 插入 -->
          </div>
        </div>

      </aside>

      <!-- 右侧展示区 -->
      <main class="display-area">

        <!-- 主图预览卡片 -->
        <div class="card" style="flex: 1; display: flex; flex-direction: column;">
          <div class="section-header">
            <h2 class="section-title">生成结果</h2>
            <div class="actions-container">
              <button id="btnDownloadFull" class="btn btn-secondary"
                style="width: auto; padding: 8px 16px; font-size: 0.85rem;" disabled>
                下载完整网格
              </button>
            </div>
          </div>

          <div class="preview-canvas empty" id="previewArea">
            <div class="placeholder-content">
              <div style="font-size: 3rem; margin-bottom: 16px;">🖼️</div>
              <p>在左侧配置并生成内容</p>
              <p style="font-size: 0.85rem; opacity: 0.6;">支持 1x1 / 3x3 / 5x5 生成与自动切片</p>
            </div>
            <img id="resultImage" style="display: none;">
            <div class="loader" id="loader" style="display: none;"></div>
          </div>

          <!-- 切片结果 -->
          <div id="slicedSection" style="margin-top: 24px; display: none;">
            <div class="section-header">
              <h3 class="section-title" style="font-size: 0.9rem;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  style="margin-right: 6px;">
                  <rect x="3" y="3" width="7" height="7"></rect>
                  <rect x="14" y="3" width="7" height="7"></rect>
                  <rect x="14" y="14" width="7" height="7"></rect>
                  <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                自动切片 (点击下载单个)
              </h3>
              <button id="btnDownloadAllSlices" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;">
                打包下载全部
              </button>
            </div>
            <div class="sliced-grid" id="slicedGrid">
              <!-- 切片将通过 JS 插入 -->
            </div>
          </div>

        </div>

      </main>
    </div>
  </div><!-- end pageSingle -->

  <!-- 风格矩阵页面 -->
  <div id="pageMatrix" class="page-view">
    <div class="main-container" style="grid-template-columns: 300px 1fr;">

      <!-- 左侧配置区 -->
      <aside class="control-panel">

        <!-- 素材管理 -->
        <div class="assets-panel">
          <div class="assets-header">
            <h3 style="margin: 0; font-size: 1rem;">📁 素材库</h3>
            <span style="font-size: 0.8rem; color: var(--text-secondary);">已选 <span id="selectedAssetsCount">0</span>
              个</span>
          </div>

          <div class="assets-categories">
            <span class="category-tag matrix-category-tab active" data-category="all">全部</span>
            <span class="category-tag matrix-category-tab" data-category="reference">🎨 参考图</span>
            <span class="category-tag matrix-category-tab" data-category="character">👤 角色</span>
            <span class="category-tag matrix-category-tab" data-category="ui">📱 UI</span>
            <span class="category-tag matrix-category-tab" data-category="scene">🏞️ 场景</span>
          </div>

          <input type="file" id="matrixAssetUpload" multiple accept="image/*" style="display: none;">
          <div class="assets-grid" id="matrixAssetsGrid">
            <div class="asset-upload-zone" onclick="document.getElementById('matrixAssetUpload').click()">
              <div class="upload-icon">➕</div>
              <span>添加素材</span>
            </div>
          </div>
        </div>

        <!-- 风格选择 -->
        <div class="card">
          <div class="section-header">
            <h3 class="section-title">🎭 风格选择</h3>
            <span style="font-size: 0.8rem; color: var(--text-secondary);">已选 <span id="selectedStylesCount">0</span>
              个</span>
          </div>
          <div class="style-selector" id="styleChipsContainer">
            <!-- 风格标签将由 JS 渲染 -->
          </div>
        </div>

        <!-- 生成配置 -->
        <div class="card">
          <h3 class="section-title" style="margin-bottom: 16px;">⚙️ 生成配置</h3>

          <div class="form-group">
            <label class="form-label">生成类型</label>
            <select id="matrixGenerationType" class="input-field">
              <option value="icon">图标 (Icon)</option>
              <option value="character">角色立绘 (Character)</option>
              <option value="scene">游戏画面 (Scene)</option>
              <option value="uiTemplate">UI 模板 (UI Template)</option>
              <option value="colorPalette">配色方案 (Color Palette)</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">生成分辨率</label>
            <select id="matrixResolution" class="input-field">
              <option value="1024">1K (1024×1024)</option>
              <option value="2048">2K (2048×2048)</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">附加描述 (可选)</label>
            <input type="text" id="matrixCustomPrompt" class="input-field" placeholder="例如：武器图标、药水道具...">
          </div>

          <div class="form-group">
            <div class="switch-container">
              <label class="switch">
                <input type="checkbox" id="concurrentSwitch">
                <span class="slider"></span>
              </label>
              <span class="switch-label">并发生成 (更快但可能触发限流)</span>
            </div>
          </div>

          <button id="btnGenerateMatrix" class="btn btn-primary">✨ 生成矩阵</button>
          <button id="btnAbortMatrix" class="btn btn-secondary" style="display: none; margin-top: 8px;">⏹️ 中止生成</button>
        </div>

      </aside>

      <!-- 右侧结果区 -->
      <main class="display-area">
        <div class="card" style="flex: 1;">
          <div class="section-header">
            <h2 class="section-title">🔲 风格矩阵结果</h2>
            <div style="display: flex; gap: 8px;">
              <button id="btnSaveExploration" class="btn btn-secondary" style="width: auto; padding: 8px 16px;">
                💾 保存方案
              </button>
            </div>
          </div>

          <!-- 进度条 -->
          <div id="matrixProgressContainer" style="display: none;">
            <div class="progress-info">
              <span>生成进度</span>
              <span id="matrixProgressText">0 / 0</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="matrixProgressBar" style="width: 0%;"></div>
            </div>
          </div>

          <!-- 矩阵结果 -->
          <div id="matrixResultContainer" style="display: none;">
            <div class="matrix-wrapper">
              <div class="matrix-grid" id="matrixGrid">
                <!-- 矩阵内容由 JS 渲染 -->
              </div>
            </div>
          </div>

          <!-- 空状态 -->
          <div id="matrixEmptyState" class="empty-state">
            <div class="icon">🔲</div>
            <div class="title">准备开始探索</div>
            <div class="desc">选择左侧的素材和风格，点击生成矩阵开始对比不同风格效果</div>
          </div>
        </div>
      </main>

    </div>
  </div><!-- end pageMatrix -->

  <!-- 探索方案页面 -->
  <div id="pageExplorations" class="page-view">
    <div class="matrix-container">
      <div class="card">
        <div class="section-header">
          <h2 class="section-title">📁 探索方案</h2>
        </div>

        <div class="exploration-list" id="explorationsList">
          <div class="empty-state">
            <div class="icon">📁</div>
            <div class="title">暂无探索方案</div>
            <div class="desc">在风格矩阵页面生成结果后可以保存为探索方案</div>
          </div>
        </div>
      </div>
    </div>
  </div><!-- end pageExplorations -->

  <!-- API Key Modal -->
  <dialog id="apiKeyDialog">
    <h3 class="dialog-title">API 设置</h3>
    <div class="form-group">
      <label class="form-label">Gemini API Key</label>
      <input type="password" id="apiKeyInput" class="input-field" placeholder="粘贴你的 key...">
    </div>
    <div class="form-group">
      <label class="form-label">Base URL（可选）</label>
      <input type="text" id="baseUrlInput" class="input-field"
        placeholder="默认：https://generativelanguage.googleapis.com/v1beta">
      <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px;">
        留空使用官方地址，或填入代理地址。所有设置仅保存在本地浏览器中。
      </p>
    </div>
    <div class="dialog-footer">
      <button id="btnCancelKey" class="btn btn-secondary" style="width: auto;">取消</button>
      <button id="btnSaveKey" class="btn btn-primary" style="width: auto;">保存</button>
    </div>
  </dialog>

  <!-- Update Dialog -->
  <dialog id="updateDialog">
    <h3 class="dialog-title">🎉 发现新版本</h3>
    <div style="margin: 16px 0;">
      <p style="margin: 8px 0;"><strong>当前版本：</strong><span id="currentVersion">未知</span></p>
      <p style="margin: 8px 0;"><strong>最新版本：</strong><span id="latestVersion">--</span></p>
      <p style="margin: 8px 0;"><strong>更新内容：</strong><span id="updateMessage">--</span></p>
      <p style="margin: 8px 0; font-size: 0.85rem; color: var(--text-secondary);">
        <strong>更新时间：</strong><span id="updateDate">--</span>
      </p>
    </div>
    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 16px;">
      点击"立即更新"将重新加载页面以获取最新版本。
    </p>
    <div class="dialog-footer">
      <button id="btnCancelUpdate" class="btn btn-secondary" style="width: auto;">稍后再说</button>
      <button id="btnConfirmUpdate" class="btn btn-primary" style="width: auto;">立即更新</button>
    </div>
  </dialog>

  <!-- Toast -->
  <div id="toast" class="toast">
    <span>消息内容</span>
  </div>

  <script type="module" src="./app.js"></script>
  <script type="module">
    // 页面切换逻辑
    document.querySelectorAll('.main-nav .nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const page = tab.dataset.page;

        // 更新 Tab 激活状态
        document.querySelectorAll('.main-nav .nav-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // 切换页面
        document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
        const pageId = 'page' + page.charAt(0).toUpperCase() + page.slice(1);
        document.getElementById(pageId)?.classList.add('active');

        // 首次切换到矩阵页面时初始化
        if (page === 'matrix') {
          if (!window.matrixAppInitialized) {
            import('./matrix-app.js').then(mod => {
              mod.initMatrixApp();
              window.matrixAppModule = mod;
              window.matrixAppInitialized = true;
            });
          } else if (window.matrixAppModule) {
            // 每次切换回来时同步最新的 API 设置
            window.matrixAppModule.refreshApiSettings();
          }
        }

        // 切换到探索方案页面时刷新列表
        if (page === 'explorations' && window.matrixAppInitialized) {
          // 探索列表会自动刷新
        }
      });
    });
  </script>
</body>

</html>